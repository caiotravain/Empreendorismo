<!-- Patients Management Tab -->
<div id="pacientes-tab" class="tab-content patient-management-container" style="display: none;">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="text-slate-800 mb-0" style="font-size: 1.5rem; font-weight: 600;">Gestão de Pacientes</h1>
        <button class="btn btn-slate-900 btn-sm" onclick="showPatientModal()">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm me-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Novo Paciente
        </button>
    </div>

    <!-- Filter & Search Form -->
    <div class="row g-2 mb-3">
        <div class="col-md-5">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
                <input type="text" class="form-control border-start-0" id="patient-search" placeholder="Buscar por nome, email ou telefone...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="patient-gender-filter">
                <option value="">Sexo: Todos</option>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
                <option value="O">Outro</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="patient-status-filter">
                <option value="active" selected>Status: Ativo</option>
                <option value="inactive">Status: Inativo</option>
                <option value="all">Status: Todos</option>
            </select>
        </div>
        <div class="col-md-1">
            <button class="btn btn-outline-secondary w-100" onclick="clearPatientFilters()">
                Limpar
            </button>
        </div>
    </div>

    <!-- Data Table (Main Card) -->
    <div class="card shadow-sm rounded-lg mb-3">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="patients-table">
                    <thead class="bg-white border-bottom">
                        <tr>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">Nome</th>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">Email</th>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">Telefone</th>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">Idade</th>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">Sexo</th>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">Status</th>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">
                                Data de Cadastro
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-xs ms-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                            </th>
                            <th class="text-slate-800 fw-medium border-0 py-2 px-3" style="font-size: 0.8rem;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="patients-table-body">
                        {% for patient in all_patients %}
                        <tr data-patient-id="{{ patient.id }}" data-patient-status="{% if patient.is_active %}active{% else %}inactive{% endif %}" class="border-bottom patient-row patient-row-clickable" style="display: none; cursor: pointer;" onclick="viewPatientDetails({{ patient.id }})">
                            <td class="py-2 px-3">
                                <span class="text-slate-900 fw-medium">
                                    {{ patient.full_name }}
                                </span>
                            </td>
                            <td class="py-2 px-3 text-slate-500" style="font-size: 0.875rem;">
                                {% if patient.email %}
                                    <span class="text-slate-500">{{ patient.email }}</span>
                                {% else %}
                                    <span class="text-slate-400">-</span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-3 text-slate-500" style="font-size: 0.875rem;">
                                {% if patient.phone %}
                                    <span class="text-slate-500">{{ patient.phone }}</span>
                                {% else %}
                                    <span class="text-slate-400">-</span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-3 text-slate-500" style="font-size: 0.875rem;">
                                {{ patient.age|default:"-" }}
                            </td>
                            <td class="py-2 px-3 text-slate-500" style="font-size: 0.875rem;">
                                {% if patient.gender == 'M' %}
                                    <span class="d-inline-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-xs me-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                        </svg>
                                        Masculino
                                    </span>
                                {% elif patient.gender == 'F' %}
                                    <span class="d-inline-flex align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-xs me-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                        </svg>
                                        Feminino
                                    </span>
                                {% else %}
                                    <span class="text-slate-500">Outro</span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-3" style="font-size: 0.875rem;">
                                {% if patient.is_active %}
                                    <span class="d-inline-flex align-items-center">
                                        <span class="status-dot bg-green-400 me-2"></span>
                                        Ativo
                                    </span>
                                {% else %}
                                    <span class="d-inline-flex align-items-center">
                                        <span class="status-dot bg-gray-300 me-2"></span>
                                        Inativo
                                    </span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-3 text-slate-500" style="font-size: 0.875rem;">
                                {{ patient.created_at|date:"d/m/Y" }}
                            </td>
                            <td class="py-2 px-3" onclick="event.stopPropagation();">
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-link text-primary p-1" onclick="accessPatientProntuario({{ patient.id }}, '{{ patient.full_name }}')" title="Acessar Prontuário">
                                        <i class="fas fa-file-medical"></i>
                                    </button>
                                    <button class="btn btn-sm btn-link text-success p-1" onclick="accessPatientPrescription({{ patient.id }}, '{{ patient.full_name }}')" title="Acessar Prescrição">
                                        <i class="fas fa-prescription-bottle-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-link text-slate-500 p-1" onclick="editPatient({{ patient.id }})" title="Editar">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    {% if patient.is_active %}
                                        <button class="btn btn-sm btn-link text-slate-500 p-1" onclick="deactivatePatient({{ patient.id }}, '{{ patient.full_name }}')" title="Desativar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-link text-slate-500 p-1" onclick="activatePatient({{ patient.id }}, '{{ patient.full_name }}')" title="Ativar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="patients-empty-row" style="display: none;">
                            <td colspan="8" class="text-center text-slate-500 py-5">
                                <p class="h6 mb-2" style="font-size: 1rem;">Nenhum paciente encontrado.</p>
                                <p class="text-slate-400" style="font-size: 0.875rem;">Clique em "Novo Paciente" para adicionar o primeiro paciente.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination Controls -->
        <div class="card-footer bg-white border-top d-flex justify-content-between align-items-center py-2">
            <div class="text-slate-500" style="font-size: 0.875rem;">
                Mostrando <span id="patients-showing-start">0</span> - <span id="patients-showing-end">0</span> de <span id="patients-total">0</span> pacientes
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0" id="patients-pagination">
                    <li class="page-item">
                        <a class="page-link text-slate-600" href="#" id="patients-prev" onclick="changePatientsPage(-1); return false;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </a>
                    </li>
                    <li class="page-item">
                        <span class="page-link text-slate-800 bg-white border-0" id="patients-page-info" style="font-size: 0.875rem;">
                            Página <span id="patients-current-page">1</span> de <span id="patients-total-pages">1</span>
                        </span>
                    </li>
                    <li class="page-item">
                        <a class="page-link text-slate-600" href="#" id="patients-next" onclick="changePatientsPage(1); return false;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Stats Footer (Bottom Row) -->
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card shadow-sm rounded-lg bg-white">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-md text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                        <div>
                            <div class="text-slate-800 fw-bold" style="font-size: 1.25rem;">
                                {% if patient_stats.total_patients %}
                                    {{ patient_stats.total_patients }}
                                {% elif all_patients %}
                                    {{ all_patients|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                            <div class="text-slate-500" style="font-size: 0.8rem;">Total de Pacientes</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm rounded-lg bg-white">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-md text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div>
                            <div class="text-slate-800 fw-bold" style="font-size: 1.25rem;">
                                {% if patient_stats.active_patients %}
                                    {{ patient_stats.active_patients }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                            <div class="text-slate-500" style="font-size: 0.8rem;">Pacientes Ativos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm rounded-lg bg-white">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon-md text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div>
                            <div class="text-slate-800 fw-bold" style="font-size: 1.25rem;">
                                {% if patient_stats.new_this_month %}
                                    {{ patient_stats.new_this_month }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                            <div class="text-slate-500" style="font-size: 0.8rem;">Novos Este Mês</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Details Modal -->
<div class="modal fade" id="patientDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Detalhes do Paciente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="patientDetailsContent">
                <!-- Patient details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-outline-primary" id="modal-prontuario-btn" onclick="accessPatientProntuarioFromModal()" title="Acessar Prontuário">
                    <i class="fas fa-file-medical me-1"></i>Prontuário
                </button>
                <button type="button" class="btn btn-outline-success" id="modal-prescricao-btn" onclick="accessPatientPrescriptionFromModal()" title="Acessar Prescrição">
                    <i class="fas fa-prescription-bottle-alt me-1"></i>Prescrição
                </button>
                <button type="button" class="btn btn-primary" onclick="editPatientFromDetails()">Editar</button>
            </div>
        </div>
    </div>
</div>

<!-- Patient Edit Modal -->
<div class="modal fade" id="patientEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Paciente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="patientEditForm">
                <div class="modal-body">
                    <input type="hidden" id="edit-patient-id" name="patient_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-first-name" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="edit-first-name" name="first_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-last-name" class="form-label">Sobrenome *</label>
                                <input type="text" class="form-control" id="edit-last-name" name="last_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="edit-email" name="email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-phone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="edit-phone" name="phone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-date-of-birth" class="form-label">Data de Nascimento *</label>
                                <input type="date" class="form-control" id="edit-date-of-birth" name="date_of_birth" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-gender" class="form-label">Sexo *</label>
                                <select class="form-select" id="edit-gender" name="gender" required>
                                    <option value="">Selecione...</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                    <option value="O">Outro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-address" class="form-label">Endereço</label>
                        <textarea class="form-control" id="edit-address" name="address" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-city" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="edit-city" name="city">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-state" class="form-label">Estado</label>
                                <input type="text" class="form-control" id="edit-state" name="state">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-zip-code" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="edit-zip-code" name="zip_code">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-emergency-contact-name" class="form-label">Nome do Contato de Emergência</label>
                                <input type="text" class="form-control" id="edit-emergency-contact-name" name="emergency_contact_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-emergency-contact-phone" class="form-label">Telefone do Contato de Emergência</label>
                                <input type="tel" class="form-control" id="edit-emergency-contact-phone" name="emergency_contact_phone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-medical-insurance" class="form-label">Convênio Médico</label>
                        <input type="text" class="form-control" id="edit-medical-insurance" name="medical_insurance">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Patient Modal -->
<div class="modal fade" id="patientCreateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Novo Paciente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="patientCreateForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-first-name" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="create-first-name" name="first_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-last-name" class="form-label">Sobrenome *</label>
                                <input type="text" class="form-control" id="create-last-name" name="last_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="create-email" name="email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-phone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="create-phone" name="phone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-date-of-birth" class="form-label">Data de Nascimento *</label>
                                <input type="date" class="form-control" id="create-date-of-birth" name="date_of_birth" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-gender" class="form-label">Sexo *</label>
                                <select class="form-select" id="create-gender" name="gender" required>
                                    <option value="">Selecione...</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Feminino</option>
                                    <option value="O">Outro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="create-address" class="form-label">Endereço</label>
                                <input type="text" class="form-control" id="create-address" name="address">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="create-city" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="create-city" name="city">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="create-state" class="form-label">Estado</label>
                                <input type="text" class="form-control" id="create-state" name="state">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="create-zip-code" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="create-zip-code" name="zip_code">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-emergency-contact-name" class="form-label">Nome do Contato de Emergência</label>
                                <input type="text" class="form-control" id="create-emergency-contact-name" name="emergency_contact_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="create-emergency-contact-phone" class="form-label">Telefone do Contato de Emergência</label>
                                <input type="tel" class="form-control" id="create-emergency-contact-phone" name="emergency_contact_phone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="create-medical-insurance" class="form-label">Plano de Saúde</label>
                                <input type="text" class="form-control" id="create-medical-insurance" name="medical_insurance">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Paciente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Patient management functions
let currentPatientId = null;
let currentPatientName = null;
let currentPatientsPage = 1;
const patientsPerPage = 6;
let filteredPatients = [];

// Search functionality
document.getElementById('patient-search').addEventListener('input', function() {
    filterPatients();
});

document.getElementById('patient-gender-filter').addEventListener('change', function() {
    filterPatients();
});

document.getElementById('patient-status-filter').addEventListener('change', function() {
    filterPatients();
});

function filterPatients() {
    const searchTerm = document.getElementById('patient-search').value.toLowerCase();
    const genderFilter = document.getElementById('patient-gender-filter').value;
    const statusFilter = document.getElementById('patient-status-filter').value;
    const rows = document.querySelectorAll('#patients-table-body tr.patient-row');
    
    filteredPatients = [];
    
    rows.forEach((row, index) => {
        const name = row.querySelector('td:first-child').textContent.trim().toLowerCase();
        const email = row.querySelector('td:nth-child(2)').textContent.trim().toLowerCase();
        const phone = row.querySelector('td:nth-child(3)').textContent.trim().toLowerCase();
        const genderElement = row.querySelector('td:nth-child(5)');
        const gender = genderElement ? genderElement.textContent.trim().toLowerCase() : '';
        // Get status from data attribute (more reliable)
        const patientStatus = row.getAttribute('data-patient-status') || '';
        
        const matchesSearch = !searchTerm || name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm);
        
        // Gender filtering
        let matchesGender = true;
        if (genderFilter === 'M') {
            matchesGender = gender.includes('masculino');
        } else if (genderFilter === 'F') {
            matchesGender = gender.includes('feminino');
        } else if (genderFilter === 'O') {
            matchesGender = gender.includes('outro');
        }
        
        // Status filtering - use data attribute for reliable filtering
        let matchesStatus = true;
        if (statusFilter === 'active') {
            matchesStatus = patientStatus === 'active';
        } else if (statusFilter === 'inactive') {
            matchesStatus = patientStatus === 'inactive';
        } else if (statusFilter === 'all') {
            matchesStatus = true;
        }
        
        const shouldShow = matchesSearch && matchesGender && matchesStatus;
        
        if (shouldShow) {
            filteredPatients.push(row);
        }
    });
    
    // Reset to page 1 when filtering
    currentPatientsPage = 1;
    displayPatientsPage();
}

function displayPatientsPage() {
    const rows = document.querySelectorAll('#patients-table-body tr.patient-row');
    const emptyRow = document.getElementById('patients-empty-row');
    const totalFiltered = filteredPatients.length;
    const totalPages = Math.ceil(totalFiltered / patientsPerPage) || 1;
    
    // Hide all rows first
    rows.forEach(row => {
        row.style.display = 'none';
    });
    
    // Hide empty row by default
    if (emptyRow) {
        emptyRow.style.display = 'none';
    }
    
    // Show empty state if no patients
    if (totalFiltered === 0) {
        if (emptyRow) {
            emptyRow.style.display = '';
        }
    } else {
        // Calculate range
        const startIndex = (currentPatientsPage - 1) * patientsPerPage;
        const endIndex = Math.min(startIndex + patientsPerPage, totalFiltered);
        
        // Show rows for current page
        for (let i = startIndex; i < endIndex; i++) {
            if (filteredPatients[i]) {
                filteredPatients[i].style.display = '';
            }
        }
    }
    
    // Update pagination info
    document.getElementById('patients-current-page').textContent = currentPatientsPage;
    document.getElementById('patients-total-pages').textContent = totalPages;
    document.getElementById('patients-total').textContent = totalFiltered;
    document.getElementById('patients-showing-start').textContent = totalFiltered > 0 ? (totalFiltered === 0 ? 0 : (currentPatientsPage - 1) * patientsPerPage + 1) : 0;
    document.getElementById('patients-showing-end').textContent = totalFiltered > 0 ? Math.min(currentPatientsPage * patientsPerPage, totalFiltered) : 0;
    
    // Update prev/next buttons
    const prevBtn = document.getElementById('patients-prev');
    const nextBtn = document.getElementById('patients-next');
    
    if (currentPatientsPage <= 1 || totalFiltered === 0) {
        prevBtn.classList.add('disabled');
        prevBtn.style.pointerEvents = 'none';
        prevBtn.style.opacity = '0.5';
    } else {
        prevBtn.classList.remove('disabled');
        prevBtn.style.pointerEvents = 'auto';
        prevBtn.style.opacity = '1';
    }
    
    if (currentPatientsPage >= totalPages || totalFiltered === 0) {
        nextBtn.classList.add('disabled');
        nextBtn.style.pointerEvents = 'none';
        nextBtn.style.opacity = '0.5';
    } else {
        nextBtn.classList.remove('disabled');
        nextBtn.style.pointerEvents = 'auto';
        nextBtn.style.opacity = '1';
    }
}

function changePatientsPage(direction) {
    const totalPages = Math.ceil(filteredPatients.length / patientsPerPage) || 1;
    const newPage = currentPatientsPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentPatientsPage = newPage;
        displayPatientsPage();
    }
}

function clearPatientFilters() {
    document.getElementById('patient-search').value = '';
    document.getElementById('patient-gender-filter').value = '';
    document.getElementById('patient-status-filter').value = 'active';
    filterPatients();
}

// Initialize pagination on page load and when tab is shown
function initializePatientsPagination() {
    if (document.getElementById('pacientes-tab') && document.getElementById('pacientes-tab').style.display !== 'none') {
        filterPatients();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initializePatientsPagination();
});

// Also initialize when tab is shown (in case it's not the default tab)
const pacientesTab = document.getElementById('pacientes-tab');
if (pacientesTab) {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                if (pacientesTab.style.display !== 'none') {
                    setTimeout(initializePatientsPagination, 50);
                }
            }
        });
    });
    observer.observe(pacientesTab, { attributes: true });
}

function viewPatientDetails(patientId) {
    currentPatientId = patientId;
    
    // Show loading state
    document.getElementById('patientDetailsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Carregando detalhes do paciente...</p>
        </div>
    `;
    
    // Show modal immediately
    new bootstrap.Modal(document.getElementById('patientDetailsModal')).show();
    
    // Fetch complete patient data from server
    fetch(`/dashboard/api/patients/${patientId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const patient = data.patient;
                currentPatientName = patient.full_name; // Store patient name for modal buttons
                displayPatientDetails(patient);
            } else {
                document.getElementById('patientDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao carregar detalhes do paciente: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching patient details:', error);
            document.getElementById('patientDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar detalhes do paciente.
                </div>
            `;
        });
}

function displayPatientDetails(patient) {
    // Create comprehensive patient details content
    const content = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center mb-3">
                    <div class="avatar-lg bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 80px; height: 80px;">
                        ${patient.full_name.split(' ').map(n => n[0]).join('').toUpperCase()}
                    </div>
                    <h5 class="mb-0">${patient.full_name}</h5>
                    <small class="text-muted">Paciente desde ${patient.created_at}</small>
                    <div class="mt-2">
                        ${patient.is_active ? 
                            '<span class="badge bg-success">Ativo</span>' : 
                            '<span class="badge bg-danger">Inativo</span>'
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-envelope me-2"></i>Email</h6>
                        <p class="text-muted">${patient.email || 'Não informado'}</p>
                        
                        <h6><i class="fas fa-phone me-2"></i>Telefone</h6>
                        <p class="text-muted">${patient.phone || 'Não informado'}</p>
                        
                        <h6><i class="fas fa-birthday-cake me-2"></i>Data de Nascimento</h6>
                        <p class="text-muted">${patient.date_of_birth ? new Date(patient.date_of_birth).toLocaleDateString('pt-BR') : 'Não informado'}</p>
                        
                        <h6><i class="fas fa-calendar-alt me-2"></i>Idade</h6>
                        <p class="text-muted">${patient.age || 0} anos</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-venus-mars me-2"></i>Sexo</h6>
                        <p class="text-muted">${patient.gender === 'M' ? 'Masculino' : patient.gender === 'F' ? 'Feminino' : 'Outro'}</p>
                        
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Endereço</h6>
                        <p class="text-muted">${patient.address || 'Não informado'}</p>
                        
                        <h6><i class="fas fa-city me-2"></i>Cidade/Estado</h6>
                        <p class="text-muted">${patient.city || 'Não informado'}${patient.state ? ', ' + patient.state : ''}</p>
                        
                        <h6><i class="fas fa-mail-bulk me-2"></i>CEP</h6>
                        <p class="text-muted">${patient.zip_code || 'Não informado'}</p>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user-friends me-2"></i>Contato de Emergência</h6>
                        <p class="text-muted">${patient.emergency_contact_name || 'Não informado'}</p>
                        
                        <h6><i class="fas fa-phone-alt me-2"></i>Telefone de Emergência</h6>
                        <p class="text-muted">${patient.emergency_contact_phone || 'Não informado'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-heartbeat me-2"></i>Plano de Saúde</h6>
                        <p class="text-muted">${patient.medical_insurance || 'Não informado'}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('patientDetailsContent').innerHTML = content;
}

function editPatient(patientId) {
    currentPatientId = patientId;
    
    // Set patient ID
    document.getElementById('edit-patient-id').value = patientId;
    
    // Fetch full patient data from server
    fetch(`/dashboard/api/patients/${patientId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const patient = data.patient;
                
                // Populate all fields with server data
                document.getElementById('edit-first-name').value = patient.first_name || '';
                document.getElementById('edit-last-name').value = patient.last_name || '';
                document.getElementById('edit-email').value = patient.email || '';
                document.getElementById('edit-phone').value = patient.phone || '';
                document.getElementById('edit-date-of-birth').value = patient.date_of_birth || '';
                document.getElementById('edit-gender').value = patient.gender || '';
                document.getElementById('edit-address').value = patient.address || '';
                document.getElementById('edit-city').value = patient.city || '';
                document.getElementById('edit-state').value = patient.state || '';
                document.getElementById('edit-zip-code').value = patient.zip_code || '';
                document.getElementById('edit-emergency-contact-name').value = patient.emergency_contact_name || '';
                document.getElementById('edit-emergency-contact-phone').value = patient.emergency_contact_phone || '';
                document.getElementById('edit-medical-insurance').value = patient.medical_insurance || '';
                
                // Show the modal after data is loaded
                new bootstrap.Modal(document.getElementById('patientEditModal')).show();
            } else {
                showAlert('error', 'Erro ao carregar dados do paciente: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Error fetching patient data:', error);
            showAlert('error', 'Erro ao carregar dados do paciente.');
        });
}

function editPatientFromDetails() {
    if (currentPatientId) {
        editPatient(currentPatientId);
        bootstrap.Modal.getInstance(document.getElementById('patientDetailsModal')).hide();
    }
}

function showPatientModal() {
    // Clear the form
    document.getElementById('patientCreateForm').reset();
    // Show the modal
    new bootstrap.Modal(document.getElementById('patientCreateModal')).show();
}

function deactivatePatient(patientId, patientName) {
    if (confirm(`Tem certeza que deseja desativar o paciente "${patientName}"?\n\nO paciente será marcado como inativo mas os dados serão preservados.`)) {
        fetch(`/dashboard/api/patients/deactivate/${patientId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showAlert('success', data.message);
                
                // Refresh the patient list
                refreshPatientsList();
            } else {
                showAlert('error', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Erro ao desativar paciente');
        });
    }
}

function activatePatient(patientId, patientName) {
    if (confirm(`Tem certeza que deseja ativar o paciente "${patientName}"?`)) {
        fetch(`/dashboard/api/patients/activate/${patientId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showAlert('success', data.message);
                
                // Refresh the patient list
                refreshPatientsList();
            } else {
                showAlert('error', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Erro ao ativar paciente');
        });
    }
}

// Handle patient edit form submission
document.getElementById('patientEditForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/dashboard/api/patients/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('patientEditModal')).hide();
            // Refresh the patient list
            refreshPatientsList();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Erro ao atualizar paciente');
    });
});

// Create patient form submission
document.getElementById('patientCreateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/dashboard/api/patients/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('patientCreateModal')).hide();
            // Refresh the patient list
            refreshPatientsList();
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Erro ao criar paciente');
    });
});

function refreshPatientsList() {
    // Refresh the patient list and maintain the pacientes tab active
    const pacientesTab = document.getElementById('pacientes-tab');
    if (!pacientesTab || pacientesTab.style.display === 'none') {
        return; // Not on pacientes tab, don't refresh
    }
    
    // Reload the page but preserve the tab state via URL parameter
    const url = new URL(window.location);
    url.searchParams.set('tab', 'pacientes');
    window.location.href = url.toString();
}

function updatePatientStats() {
    // Update the statistics cards
    const totalPatients = document.querySelectorAll('#patients-table-body tr:not([style*="display: none"])').length;
    document.querySelector('.card.bg-primary .card-body h4').textContent = totalPatients;
    document.querySelector('.card.bg-success .card-body h4').textContent = totalPatients;
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Utility function to show alerts
function showAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert alert at the top of the tab content
    const tabContent = document.getElementById('pacientes-tab');
    const existingAlert = tabContent.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    tabContent.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        const alert = tabContent.querySelector('.alert');
        if (alert) {
            bootstrap.Alert.getOrCreateInstance(alert).close();
        }
    }, 5000);
}

// Initialize filters when page loads
document.addEventListener('DOMContentLoaded', function() {
    filterPatients();
});

// Function to access patient prontuario
function accessPatientProntuario(patientId, patientName) {
    // Set pending tab switch to prontuarios before selecting patient
    if (typeof window !== 'undefined') {
        window.pendingTabSwitch = 'prontuarios';
    }
    
    // Select the patient (this will trigger the tab switch via pendingTabSwitch)
    if (typeof selectPatient === 'function') {
        selectPatient(patientName, patientId);
    } else {
        // Fallback: manually set patient and switch tab
        if (typeof selectedPatient !== 'undefined') {
            selectedPatient = {
                name: patientName,
                id: patientId
            };
            localStorage.setItem('selectedPatient', JSON.stringify(selectedPatient));
            
            // Update patient info if function exists
            if (typeof updatePatientInfo === 'function') {
                updatePatientInfo(patientName);
            }
            
            // Enable tabs
            const disabledButtons = document.querySelectorAll('.btn-group .btn.disabled');
            disabledButtons.forEach(btn => {
                btn.classList.remove('disabled');
                btn.disabled = false;
            });
        }
        
        // Switch to prontuarios tab
        if (typeof switchTab === 'function') {
            setTimeout(() => {
                switchTab('prontuarios');
            }, 100);
        }
    }
}

// Function to access patient prescription
function accessPatientPrescription(patientId, patientName) {
    // Set pending tab switch to prescricao before selecting patient
    if (typeof window !== 'undefined') {
        window.pendingTabSwitch = 'prescricao';
    }
    
    // Select the patient (this will trigger the tab switch via pendingTabSwitch)
    if (typeof selectPatient === 'function') {
        selectPatient(patientName, patientId);
    } else {
        // Fallback: manually set patient and switch tab
        if (typeof selectedPatient !== 'undefined') {
            selectedPatient = {
                name: patientName,
                id: patientId
            };
            localStorage.setItem('selectedPatient', JSON.stringify(selectedPatient));
            
            // Update patient info if function exists
            if (typeof updatePatientInfo === 'function') {
                updatePatientInfo(patientName);
            }
            
            // Enable tabs
            const disabledButtons = document.querySelectorAll('.btn-group .btn.disabled');
            disabledButtons.forEach(btn => {
                btn.classList.remove('disabled');
                btn.disabled = false;
            });
        }
        
        // Switch to prescricao tab
        if (typeof switchTab === 'function') {
            setTimeout(() => {
                switchTab('prescricao');
            }, 100);
        }
    }
}

// Function to access patient prontuario from modal
function accessPatientProntuarioFromModal() {
    if (currentPatientId && currentPatientName) {
        // Close the modal first
        const modal = bootstrap.Modal.getInstance(document.getElementById('patientDetailsModal'));
        if (modal) {
            modal.hide();
        }
        
        // Then access prontuario
        accessPatientProntuario(currentPatientId, currentPatientName);
    }
}

// Function to access patient prescription from modal
function accessPatientPrescriptionFromModal() {
    if (currentPatientId && currentPatientName) {
        // Close the modal first
        const modal = bootstrap.Modal.getInstance(document.getElementById('patientDetailsModal'));
        if (modal) {
            modal.hide();
        }
        
        // Then access prescription
        accessPatientPrescription(currentPatientId, currentPatientName);
    }
}
</script>
