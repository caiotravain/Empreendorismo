<!-- Indicadores Tab -->
<div id="indicadores-tab" class="tab-content" style="display: none;">
    <!-- Control Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-slate-800 mb-0" style="font-size: 1.5rem; font-weight: 600;">Indicadores de Performance</h1>
        <div class="position-relative">
            <select class="form-select bg-white border border-slate-200 rounded-lg px-4 py-2" id="period-filter" style="min-width: 180px; appearance: none; padding-right: 2.5rem;">
                <option value="30">Últimos 30 Dias</option>
                <option value="month" selected>Este Mês</option>
                <option value="quarter">Último Trimestre</option>
                <option value="year">Este Ano</option>
            </select>
            <svg xmlns="http://www.w3.org/2000/svg" class="position-absolute top-50 end-0 translate-middle-y me-3 text-slate-400" style="pointer-events: none; right: 0;" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
    </div>

    <!-- Section 1: The "Pulse" - 4 KPI Cards -->
    <div class="row mb-4">
        <!-- Card 1: Show Rate -->
        <div class="col-md-3 mb-3">
            <div class="card border border-slate-200 rounded-xl shadow-sm bg-white">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-slate-500 mb-1" style="font-size: 0.875rem; font-weight: 500;">Taxa de Comparecimento</p>
                            <h3 class="mb-0 text-emerald-600 fw-bold" id="show-rate-value">
                                0%
                            </h3>
                            <p class="text-slate-400 mb-0 mt-1" style="font-size: 0.75rem;">Meta: 95%</p>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="text-emerald-600" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 2: Total Patients -->
        <div class="col-md-3 mb-3">
            <div class="card border border-slate-200 rounded-xl shadow-sm bg-white">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-slate-500 mb-1" style="font-size: 0.875rem; font-weight: 500;">Total de Pacientes</p>
                            <h3 class="mb-0 text-slate-900 fw-bold" id="total-patients-value">
                                0
                            </h3>
                            <p class="text-slate-400 mb-0 mt-1" style="font-size: 0.75rem;">Pacientes cadastrados</p>
                        </div>
                        <div class="bg-slate-50 rounded-lg p-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="text-slate-600" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 3: Patient Mix -->
        <div class="col-md-3 mb-3">
            <div class="card border border-slate-200 rounded-xl shadow-sm bg-white">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-slate-500 mb-1" style="font-size: 0.875rem; font-weight: 500;">Mix de Pacientes</p>
                            <h3 class="mb-0 text-blue-600 fw-bold" id="patient-mix-value">
                                0% Particular
                            </h3>
                            <p class="text-slate-400 mb-0 mt-1" style="font-size: 0.75rem;" id="insurance-pct-text">0% Convênio</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="text-blue-600" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 4: Retention -->
        <div class="col-md-3 mb-3">
            <div class="card border border-slate-200 rounded-xl shadow-sm bg-white">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-slate-500 mb-1" style="font-size: 0.875rem; font-weight: 500;">Retenção</p>
                            <h3 class="mb-0 text-amber-600 fw-bold" id="retention-value">
                                0%
                            </h3>
                            <p class="text-slate-400 mb-0 mt-1" style="font-size: 0.75rem;">Pacientes retornando</p>
                        </div>
                        <div class="bg-amber-50 rounded-lg p-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="text-amber-600" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Deep Dive - Charts -->
    <div class="row mb-4">
        <!-- Container 1: Attendance Breakdown (Donut Chart) -->
        <div class="col-lg-6 mb-3">
            <div class="card border border-slate-200 rounded-xl shadow-sm bg-white">
                <div class="card-body p-4">
                    <h6 class="text-slate-800 fw-semibold mb-3" style="font-size: 0.875rem;">Comparecimento vs. Faltas e Cancelamentos</h6>
                    <div style="height: 300px; position: relative;">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                    <div class="d-flex justify-content-center gap-4 mt-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="rounded-circle d-inline-block" style="width: 12px; height: 12px; background-color: #10b981;"></span>
                            <span class="text-slate-600" style="font-size: 0.875rem;">Comparecimento</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="rounded-circle d-inline-block" style="width: 12px; height: 12px; background-color: #f43f5e;"></span>
                            <span class="text-slate-600" style="font-size: 0.875rem;">Faltas</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="rounded-circle d-inline-block" style="width: 12px; height: 12px; background-color: #6b7280;"></span>
                            <span class="text-slate-600" style="font-size: 0.875rem;">Cancelados</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Container 2: Financial Source (Horizontal Bar) -->
        <div class="col-lg-6 mb-3">
            <div class="card border border-slate-200 rounded-xl shadow-sm bg-white">
                <div class="card-body p-4">
                    <h6 class="text-slate-800 fw-semibold mb-3" style="font-size: 0.875rem;">Volume Particular vs. Convênio</h6>
                    <div style="height: 300px; position: relative;">
                        <canvas id="financialSourceChart"></canvas>
                    </div>
                    <div class="d-flex justify-content-center gap-4 mt-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="rounded-circle d-inline-block" style="width: 12px; height: 12px; background-color: #3b82f6;"></span>
                            <span class="text-slate-600" style="font-size: 0.875rem;">Particular</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="rounded-circle d-inline-block" style="width: 12px; height: 12px; background-color: #64748b;"></span>
                            <span class="text-slate-600" style="font-size: 0.875rem;">Convênio</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Detailed Insights Table -->
    <div class="card border border-slate-200 rounded-xl shadow-sm bg-white">
        <div class="card-body p-4">
            <h6 class="text-slate-800 fw-semibold mb-3" style="font-size: 0.875rem;">Performance por Operadora de Convênio</h6>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-slate-50 border-bottom">
                        <tr>
                            <th class="text-slate-800 fw-medium border-0 py-3 px-4" style="font-size: 0.875rem;">Operadora</th>
                            <th class="text-slate-800 fw-medium border-0 py-3 px-4 text-center" style="font-size: 0.875rem;">Total de Consultas</th>
                            <th class="text-slate-800 fw-medium border-0 py-3 px-4 text-end" style="font-size: 0.875rem;">Receita Gerada</th>
                            <th class="text-slate-800 fw-medium border-0 py-3 px-4 text-end" style="font-size: 0.875rem;">Ticket Médio</th>
                        </tr>
                    </thead>
                    <tbody id="insurance-providers-table">
                        <tr>
                            <td colspan="4" class="text-center text-slate-500 py-4">Carregando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize charts when indicadores tab is shown
let attendanceChart = null;
let financialSourceChart = null;
let currentMetrics = null;

// Load indicators data from API
function loadIndicatorsData(period = 'month') {
    fetch(`/dashboard/api/indicators/?period=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentMetrics = data.metrics;
                updateIndicatorsDisplay(data.metrics);
                updateIndicatorsCharts(data.metrics);
                updateInsuranceProvidersTable(data.metrics.providers || []);
            } else {
                console.error('Error loading indicators:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading indicators:', error);
        });
}

// Update HTML elements with real data
function updateIndicatorsDisplay(metrics) {
    // Show Rate
    const showRateEl = document.getElementById('show-rate-value');
    if (showRateEl) {
        showRateEl.textContent = (metrics.show_rate || 0).toFixed(1) + '%';
    }
    
    // Total Patients
    const totalPatientsEl = document.getElementById('total-patients-value');
    if (totalPatientsEl) {
        totalPatientsEl.textContent = metrics.total_patients || 0;
    }
    
    // Patient Mix
    const patientMixEl = document.getElementById('patient-mix-value');
    if (patientMixEl) {
        patientMixEl.textContent = (metrics.private_pct || 0).toFixed(1) + '% Particular';
    }
    const insurancePctEl = document.getElementById('insurance-pct-text');
    if (insurancePctEl) {
        insurancePctEl.textContent = (metrics.insurance_pct || 0).toFixed(1) + '% Convênio';
    }
    
    // Retention
    const retentionEl = document.getElementById('retention-value');
    if (retentionEl) {
        retentionEl.textContent = (metrics.retention_rate || 0).toFixed(1) + '%';
    }
}

// Store counts globally for tooltip access
let attendanceCounts = [0, 0, 0];
let financialCounts = {'Particular': 0, 'Convênio': 0};

// Update charts with real data
function updateIndicatorsCharts(metrics) {
    // Attendance Breakdown Donut Chart
    const attendanceCtx = document.getElementById('attendanceChart');
    if (attendanceCtx) {
        if (attendanceChart) {
            attendanceChart.destroy();
        }
        
        // Store absolute counts for tooltip
        attendanceCounts = [
            metrics.attended_count || 0,
            metrics.no_show_count || 0,
            metrics.cancelled_count || 0
        ];
        
        attendanceChart = new Chart(attendanceCtx, {
            type: 'doughnut',
            data: {
                labels: ['Comparecimento', 'Faltas', 'Cancelados'],
                datasets: [{
                    data: [
                        metrics.show_rate || 0,
                        metrics.no_show_rate || 0,
                        metrics.cancelled_rate || 0
                    ],
                    backgroundColor: [
                        '#10b981', // Emerald for Show
                        '#f43f5e', // Rose for No-Show
                        '#6b7280'  // Gray for Cancelled
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const percentage = context.parsed || 0;
                                const index = context.dataIndex;
                                const count = attendanceCounts[index] || 0;
                                return label + ': ' + percentage.toFixed(1) + '% (' + count + ' consultas)';
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }

    // Financial Source Horizontal Bar Chart
    const financialCtx = document.getElementById('financialSourceChart');
    if (financialCtx) {
        if (financialSourceChart) {
            financialSourceChart.destroy();
        }
        
        // Store absolute counts for tooltip
        financialCounts = {
            'Particular': metrics.particular_count || 0,
            'Convênio': metrics.convenio_count || 0
        };
        
        financialSourceChart = new Chart(financialCtx, {
            type: 'bar',
            data: {
                labels: ['Volume'],
                datasets: [
                    {
                        label: 'Particular',
                        data: [metrics.private_pct || 0],
                        backgroundColor: '#3b82f6',
                        borderWidth: 0
                    },
                    {
                        label: 'Convênio',
                        data: [metrics.insurance_pct || 0],
                        backgroundColor: '#64748b',
                        borderWidth: 0
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const percentage = context.parsed.x || 0;
                                const count = financialCounts[label] || 0;
                                return label + ': ' + percentage.toFixed(1) + '% (' + count + ' consultas)';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        ticks: {
                            display: false
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
}

// Update insurance providers table
function updateInsuranceProvidersTable(providers) {
    const tableBody = document.getElementById('insurance-providers-table');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (providers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 py-4">Nenhum dado disponível</td></tr>';
        return;
    }
    
    providers.forEach(provider => {
        const row = document.createElement('tr');
        row.className = 'border-bottom';
        row.innerHTML = `
            <td class="py-3 px-4">
                <span class="text-slate-900 fw-medium">${provider.name}</span>
            </td>
            <td class="py-3 px-4 text-center text-slate-600">${provider.total_appointments}</td>
            <td class="py-3 px-4 text-end">
                <span class="text-slate-900 fw-medium">R$ ${provider.revenue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
            </td>
            <td class="py-3 px-4 text-end">
                <span class="text-slate-600">R$ ${provider.avg_ticket.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Initialize charts when tab becomes visible
document.addEventListener('DOMContentLoaded', function() {
    const indicadoresTab = document.getElementById('indicadores-tab');
    const periodFilter = document.getElementById('period-filter');
    
    // Load data when period filter changes
    if (periodFilter) {
        periodFilter.addEventListener('change', function() {
            loadIndicatorsData(this.value);
        });
    }
    
    if (indicadoresTab) {
        const observer = new MutationObserver(function(mutations) {
            if (indicadoresTab.style.display !== 'none') {
                // Load data with current period filter value
                const period = periodFilter ? periodFilter.value : 'month';
                loadIndicatorsData(period);
            }
        });
        observer.observe(indicadoresTab, { attributes: true, attributeFilter: ['style'] });
        
        // Also check on tab switch
        const originalSwitchTab = window.switchTab;
        if (originalSwitchTab) {
            window.switchTab = function(tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'indicadores') {
                    const period = periodFilter ? periodFilter.value : 'month';
                    setTimeout(() => loadIndicatorsData(period), 200);
                }
            };
        }
    }
});
</script>
