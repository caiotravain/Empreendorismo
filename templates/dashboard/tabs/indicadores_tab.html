<!-- Indicadores Tab: Performance + Pacientes with live data -->
<div id="indicadores-tab" class="tab-content" style="display: none;">
    <div class="indicadores-wrapper">
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <label for="indicadores-month-select" class="form-label mb-0 text-muted small">Mês</label>
                        <select id="indicadores-month-select" class="form-select indicadores-dropdown" aria-label="Selecionar mês" style="max-width: 160px;"></select>
                    </div>
                    <select id="indicadores-view-dropdown" class="form-select indicadores-dropdown" aria-label="Selecionar visão" style="max-width: 180px;">
                        <option value="performance" selected>Performance</option>
                        <option value="pacientes">Pacientes</option>
                    </select>
                </div>

                <!-- View A: Performance -->
                <div id="indicadores-view-performance" class="indicadores-view active">
                    <div class="indicadores-main-grid">
                        <section class="indicadores-chart-section">
                            <h2 class="indicadores-chart-title">Agenda Mensal (%)</h2>
                            <div class="indicadores-chart-wrap" style="min-height:280px; position:relative;">
                                <canvas id="chart-performance" aria-label="Agenda mensal: Ocupação, Vago, No-show, Cancelamento"></canvas>
                            </div>
                        </section>
                        <section class="indicadores-kpi-section">
                            <h2 class="indicadores-kpi-title">Principais indicadores</h2>
                            <div class="indicadores-kpi-grid">
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="total_consultas">—</span><div class="indicadores-kpi-label">Total Consultas</div></div>
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="total_retornos">—</span><div class="indicadores-kpi-label">Total Retornos</div></div>
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="media_consultas_dia">—</span><div class="indicadores-kpi-label">Média Consultas/Dia</div></div>
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="tempo_medio">—</span><div class="indicadores-kpi-label">Tempo médio Consulta (mm'ss")</div></div>
                            </div>
                        </section>
                    </div>
                    <footer class="indicadores-footer">
                        <div class="indicadores-footer-header">
                            <h3 class="indicadores-footer-title">Tendência (vs mês anterior)</h3>
                        </div>
                        <div class="indicadores-trends">
                            <div class="indicadores-trend-item">
                                <div class="indicadores-trend-value-row"><span class="indicadores-trend-value" data-metric="trend_ocupacao_val">—</span><span class="indicadores-trend-delta" data-metric="trend_ocupacao_delta">—</span></div>
                                <span class="indicadores-trend-label"><svg class="indicadores-trend-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Ocupação (%)</span>
                            </div>
                            <div class="indicadores-trend-item">
                                <div class="indicadores-trend-value-row"><span class="indicadores-trend-value" data-metric="trend_cancelamento_val">—</span><span class="indicadores-trend-delta" data-metric="trend_cancelamento_delta">—</span></div>
                                <span class="indicadores-trend-label"><svg class="indicadores-trend-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Cancelamentos (%)</span>
                            </div>
                            <div class="indicadores-trend-item">
                                <div class="indicadores-trend-value-row"><span class="indicadores-trend-value" data-metric="trend_noshow_val">—</span><span class="indicadores-trend-delta" data-metric="trend_noshow_delta">—</span></div>
                                <span class="indicadores-trend-label"><svg class="indicadores-trend-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>No-show (%)</span>
                            </div>
                        </div>
                    </footer>
                </div>

                <!-- View B: Pacientes -->
                <div id="indicadores-view-pacientes" class="indicadores-view">
                    <div class="indicadores-main-grid">
                        <section class="indicadores-chart-section">
                            <h2 class="indicadores-chart-title">Segmentação Consultas - Particular e convênio</h2>
                            <div class="indicadores-chart-wrap" style="min-height:280px; position:relative;">
                                <canvas id="chart-pacientes" aria-label="Segmentação Particular e Convênio por mês"></canvas>
                            </div>
                        </section>
                        <section class="indicadores-kpi-section">
                            <h2 class="indicadores-kpi-title">Principais indicadores</h2>
                            <div class="indicadores-kpi-grid">
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="pacientes_recorrentes">—</span><div class="indicadores-kpi-label">Pacientes Recorrentes</div></div>
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="total_consultas_pac">—</span><div class="indicadores-kpi-label">Total Consultas</div></div>
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="pacientes_particular">—</span><div class="indicadores-kpi-label">Pacientes Particular</div></div>
                                <div class="indicadores-kpi-item"><span class="indicadores-kpi-value" data-metric="pacientes_convenio">—</span><div class="indicadores-kpi-label">Pacientes Convênio</div></div>
                            </div>
                        </section>
                    </div>
                    <footer class="indicadores-footer">
                        <div class="indicadores-footer-header">
                            <h3 class="indicadores-footer-title">Tendência (vs mês anterior)</h3>
                        </div>
                        <div class="indicadores-trends">
                            <div class="indicadores-trend-item">
                                <div class="indicadores-trend-value-row"><span class="indicadores-trend-value" data-metric="trend_novos_val">—</span><span class="indicadores-trend-delta" data-metric="trend_novos_delta">—</span></div>
                                <span class="indicadores-trend-label">Novos (%)</span>
                            </div>
                            <div class="indicadores-trend-item">
                                <div class="indicadores-trend-value-row"><span class="indicadores-trend-value" data-metric="trend_retencao_val">—</span><span class="indicadores-trend-delta" data-metric="trend_retencao_delta">—</span></div>
                                <span class="indicadores-trend-label">Retenção (%)</span>
                            </div>
                            <div class="indicadores-trend-item">
                                <div class="indicadores-trend-value-row"><span class="indicadores-trend-value" data-metric="trend_media_val">—</span><span class="indicadores-trend-delta" data-metric="trend_media_delta">—</span></div>
                                <span class="indicadores-trend-label">Média de Consultas/Paciente</span>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var dropdown = document.getElementById('indicadores-view-dropdown');
    var views = {
        performance: document.getElementById('indicadores-view-performance'),
        pacientes: document.getElementById('indicadores-view-pacientes')
    };
    function setActiveView(key) {
        Object.keys(views).forEach(function(k) {
            var el = views[k];
            if (el) el.classList.toggle('active', k === key);
        });
    }
    if (dropdown) dropdown.addEventListener('change', function() { setActiveView(this.value); });

    var monthSelect = document.getElementById('indicadores-month-select');
    var monthNames = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    function buildMonthOptions() {
        if (!monthSelect) return;
        var now = new Date();
        var html = '';
        for (var i = 0; i < 24; i++) {
            var d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            var y = d.getFullYear();
            var m = d.getMonth() + 1;
            var val = y + '-' + (m < 10 ? '0' + m : m);
            var label = monthNames[d.getMonth()] + ' ' + y;
            var sel = i === 0 ? ' selected' : '';
            html += '<option value="' + val + '"' + sel + '>' + label + '</option>';
        }
        monthSelect.innerHTML = html;
    }
    buildMonthOptions();
    if (monthSelect) monthSelect.addEventListener('change', function() { loadIndicatorsData(); });

    var chartPerformance = null;
    var chartPacientes = null;

    function formatDuration(minutes) {
        if (minutes == null || isNaN(minutes)) return "—";
        var m = Math.floor(minutes);
        var s = Math.round((minutes - m) * 60);
        if (s >= 60) { s = 0; m += 1; }
        return m + "'" + (s < 10 ? '0' : '') + s + '"';
    }
    function formatDelta(val, isPct) {
        if (val == null || isNaN(val)) return '';
        var s = val >= 0 ? '+' : '';
        return s + (isPct ? val + '%' : val + 'p.p.');
    }
    function deltaClass(val) {
        if (val == null) return '';
        return val < 0 ? 'positive' : (val > 0 ? 'negative' : '');
    }

    function updatePerformanceKPIs(m) {
        var map = {
            'total_consultas': m.total_appointments,
            'total_retornos': m.total_retornos,
            'media_consultas_dia': m.avg_consultations_per_day,
            'tempo_medio': formatDuration(m.avg_duration_minutes)
        };
        Object.keys(map).forEach(function(key) {
            var el = document.querySelector('.indicadores-view.active [data-metric="' + key + '"]');
            if (el) el.textContent = map[key] != null && map[key] !== '' ? map[key] : '—';
        });
        var trendVal = { trend_ocupacao_val: m.show_rate, trend_cancelamento_val: m.cancelled_rate + '%', trend_noshow_val: m.no_show_rate + '%' };
        var trendDelta = { trend_ocupacao_delta: m.trend_ocupacao_pp, trend_cancelamento_delta: m.trend_cancelamento_pp, trend_noshow_delta: m.trend_noshow_pp };
        Object.keys(trendVal).forEach(function(k) {
            var e = document.querySelector('#indicadores-view-performance [data-metric="' + k + '"]');
            if (e) e.textContent = trendVal[k] != null ? trendVal[k] : '—';
        });
        Object.keys(trendDelta).forEach(function(k) {
            var e = document.querySelector('#indicadores-view-performance [data-metric="' + k + '"]');
            if (e) {
                var v = trendDelta[k];
                e.textContent = formatDelta(v, false);
                var cls = 'indicadores-trend-delta ';
                if (v != null && v !== 0) {
                    if (k === 'trend_ocupacao_delta') cls += v > 0 ? 'positive' : 'negative';
                    else if (k === 'trend_cancelamento_delta') cls += v > 0 ? 'negative' : 'positive';
                    else if (k === 'trend_noshow_delta') cls += v < 0 ? 'positive' : 'negative';
                }
                e.className = cls;
            }
        });
    }
    function updatePacientesKPIs(m) {
        var recorrentes = (m.total_unique_patients || 0) - (m.new_patients_count || 0);
        var map = {
            'pacientes_recorrentes': recorrentes,
            'total_consultas_pac': m.total_appointments,
            'pacientes_particular': m.particular_count,
            'pacientes_convenio': m.convenio_count
        };
        Object.keys(map).forEach(function(key) {
            var el = document.querySelector('#indicadores-view-pacientes [data-metric="' + key + '"]');
            if (el) el.textContent = map[key] != null ? map[key] : '—';
        });
        var v1 = document.querySelector('#indicadores-view-pacientes [data-metric="trend_novos_val"]');
        if (v1) v1.textContent = m.new_patients_count != null ? m.new_patients_count : '—';
        var d1 = document.querySelector('#indicadores-view-pacientes [data-metric="trend_novos_delta"]');
        if (d1) { d1.textContent = formatDelta(m.trend_novos_pct, true); d1.className = 'indicadores-trend-delta ' + (m.trend_novos_pct != null && m.trend_novos_pct >= 0 ? 'positive' : 'negative'); }
        var v2 = document.querySelector('#indicadores-view-pacientes [data-metric="trend_retencao_val"]');
        if (v2) v2.textContent = m.retention_rate != null ? m.retention_rate + '%' : '—';
        var d2 = document.querySelector('#indicadores-view-pacientes [data-metric="trend_retencao_delta"]');
        if (d2) { d2.textContent = formatDelta(m.trend_retencao_pp, false); d2.className = 'indicadores-trend-delta ' + (m.trend_retencao_pp != null && m.trend_retencao_pp <= 0 ? 'negative' : 'positive'); }
        var v3 = document.querySelector('#indicadores-view-pacientes [data-metric="trend_media_val"]');
        if (v3) v3.textContent = m.avg_consultations_per_patient != null ? m.avg_consultations_per_patient : '—';
        var d3 = document.querySelector('#indicadores-view-pacientes [data-metric="trend_media_delta"]');
        if (d3) { d3.textContent = formatDelta(m.trend_media_consultas_pct, true); d3.className = 'indicadores-trend-delta ' + (m.trend_media_consultas_pct != null && m.trend_media_consultas_pct >= 0 ? 'positive' : 'negative'); }
    }

    function drawCharts(m) {
        if (typeof Chart === 'undefined') return;
        var agenda = m.monthly_agenda || [];
        var meses = agenda.map(function(x) { return x.month; });
        if (chartPerformance) { chartPerformance.destroy(); chartPerformance = null; }
        var canvasPerf = document.getElementById('chart-performance');
        if (canvasPerf && meses.length) {
            chartPerformance = new Chart(canvasPerf, {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [
                        { label: 'Ocupação', data: agenda.map(function(x) { return x.ocupacao; }), backgroundColor: '#34d399', borderWidth: 0 },
                        { label: 'Vago', data: agenda.map(function(x) { return x.vago; }), backgroundColor: '#facc15', borderWidth: 0 },
                        { label: 'No-show', data: agenda.map(function(x) { return x.no_show; }), backgroundColor: '#94a3b8', borderWidth: 0 },
                        { label: 'Cancelamento', data: agenda.map(function(x) { return x.cancelamento; }), backgroundColor: '#f87171', borderWidth: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, max: 100, ticks: { callback: function(v) { return v + '%'; } } }
                    },
                    plugins: { legend: { display: true, position: 'top' } }
                }
            });
        }
        var patients = m.monthly_patients || [];
        var mesesP = patients.map(function(x) { return x.month; });
        if (chartPacientes) { chartPacientes.destroy(); chartPacientes = null; }
        var canvasPac = document.getElementById('chart-pacientes');
        if (canvasPac && mesesP.length) {
            chartPacientes = new Chart(canvasPac, {
                type: 'line',
                data: {
                    labels: mesesP,
                    datasets: [
                        { label: 'Particular', data: patients.map(function(x) { return x.particular; }), borderColor: '#0A0A33', backgroundColor: 'rgba(10,10,51,0.06)', fill: true, tension: 0.4 },
                        { label: 'Convênio', data: patients.map(function(x) { return x.convenio; }), borderColor: '#64748b', backgroundColor: 'rgba(100,116,139,0.08)', fill: true, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: {}, y: { beginAtZero: true } },
                    plugins: { legend: { display: true, position: 'top' } }
                }
            });
        }
    }

    function loadIndicatorsData() {
        var year = '', month = '';
        if (monthSelect && monthSelect.value) {
            var parts = monthSelect.value.split('-');
            if (parts.length === 2) { year = parts[0]; month = parts[1]; }
        }
        var q = new URLSearchParams();
        if (year && month) { q.set('year', year); q.set('month', month); }
        else q.set('period', 'month');
        fetch('/dashboard/api/indicators/?' + q.toString())
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.success || !data.metrics) {
                    console.error('Indicadores:', data.error || 'Erro ao carregar');
                    return;
                }
                var m = data.metrics;
                updatePerformanceKPIs(m);
                updatePacientesKPIs(m);
                drawCharts(m);
            })
            .catch(function(err) { console.error('Indicadores:', err); });
    }

    var indicadoresTab = document.getElementById('indicadores-tab');
    if (indicadoresTab) {
        if (indicadoresTab.style.display !== 'none') loadIndicatorsData();
        var obs = new MutationObserver(function() {
            if (indicadoresTab.style.display !== 'none') loadIndicatorsData();
        });
        obs.observe(indicadoresTab, { attributes: true, attributeFilter: ['style'] });
    }
    if (typeof switchTab === 'function') {
        var orig = window.switchTab;
        window.switchTab = function(tabName) {
            orig.apply(this, arguments);
            if (tabName === 'indicadores') setTimeout(loadIndicatorsData, 100);
        };
    }
})();
</script>
